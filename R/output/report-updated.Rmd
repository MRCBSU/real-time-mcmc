---
title: 'COVID-19: nowcast and forecast'
author: "Paul Birrell, Joshua Blake, Edwin van Leeuwen, MRC Biostatistics Unit COVID-19 Working Group, Daniela De Angelis."
date: "`r lubridate::today()`"
output:
  html_document:
    self_contained: no
---

<base target="_parent">

```{r preamble, include=FALSE}
if (!exists("external")) external = T
knitr::opts_chunk$set(echo = FALSE, cache.path = "~/tmp/cache")
QUANTILES <- c(0.025, 0.5, 0.975)

suppressMessages(library(knitr))
suppressMessages(library(DT))
suppressMessages(library(lubridate))
suppressMessages(library(plotly))
suppressMessages(library(tidyverse))
if(exists("Rfile.loc")) {
  source(file.path(Rfile.loc, "results_api.R"))
} else {
  proj.dir <- "~/RTM"
  source("results_api.R")
}
results_hash = tools::md5sum(file.path(out.dir, "output_matrices.RData"))
if (external && exists("dth.dat")) {
	dth.dat <- filter(dth.dat, date <= ymd(date.data) - reporting.delay)
	results_hash = NULL
}

```


```{r plot-function}
title <- function(name) {
  list(
    text = str_replace_all(name, "_", " "),
    xref = "paper",
    yref = "paper",
    yanchor = "top",
    xanchor = "left",
    x = 0.1,
    y = 0.9,
    font = list(size = 20),
    showarrow = FALSE
  )
}

create.base.subplot <- function(data, num.rows, subplot_title) {
  lines <- list(
    list(
        type = "line", 
        y0 = 0, 
        y1 = 1, 
        yref = "paper",
        x0 = ymd(date.data), 
        x1 = ymd(date.data), 
        line = list(color = "red"),
        hoverinfo = "Today"
    ),
    list(
        type = "line", 
        y0 = 0, 
        y1 = 1, 
        yref = "paper",
        x0 = ymd(20200323), 
        x1 = ymd(20200323), 
        line = list(color = "blue"),
        hoverinfo = "Lockdown"
    ),
    list(
        type = "line", 
        y0 = 0, 
        y1 = 1, 
        yref = "paper",
        x0 = ymd(20200511), 
        x1 = ymd(20200511), 
        line = list(color = "blue"),
        hoverinfo = "Lockdown"
    )
  )
  plot.height <- num.rows * 420 + 150
  return(
    plot_ly(data, x = ~date, width = 800, height = plot.height) %>%
      layout(shapes = lines, annotations = title(subplot_title), showlegend = FALSE,
             hovermode = "x unified")
  )
}

make.plots <- function(projections, ylab = "", by = NULL, data = NULL,
                       y.format = ".3s", combine.to.England = sum.all,
                       combine.data.to.England = sum.all.data,
                       project.forwards = !is.null(data), x.label = "") {

  if (is.null(combine.to.England)) {
    Eng_projection <- Eng_data <- NULL
  } else {
    Eng_projection <- combine.to.England(projections) %>% add.quantiles(NULL, QUANTILES)
    Eng_data <- combine.data.to.England(data)
  }
  projections <- get.aggregated.quantiles(projections, by, c(0.025, 0.5, 0.975)) %>%
    rename(by = all_of(by))
  if (!project.forwards) {
    if (!is.null(Eng_projection)) {
      Eng_projection <- filter(Eng_projection, date <= ymd(date.data))
    }
    projections <- filter(projections, date <= ymd(date.data))
  }
  plot.names <- unique(projections$by)
  num.plots <- length(plot.names)
  if (!is.null(Eng_projection)) num.plots <- num.plots + 1
  num.rows <- ceiling(num.plots/2)
  date <- ymd(date.data)
  create.subplot <- function(projections, subplot_title, data) {
    plot <- projections %>%
      pivot_wider(names_from = quantile) %>%
      create.base.subplot(num.rows, subplot_title) %>%
      add_ribbons(ymin = ~`0.025`, ymax = ~`0.975`, color = I("lightblue2"), alpha = 0.25,
                hovertemplate = paste0("%{x}: %{y:", y.format, "}<extra>Upper 95% CrI</extra>")) %>%
      add_lines(y = ~`0.025`, alpha = 0,   # An extra trace just for hover text
                hovertemplate = paste0("%{x}: %{y:", y.format, "}<extra>Lower 95% CrI</extra>")) %>%
      add_lines(y = ~`0.5`, color = I("black"),
                hovertemplate = paste0("%{x}: %{y:", y.format, "}<extra>Median</extra>")) %>%
      layout(xaxis = list(title = x.label))
    if (is.null(data)) {
      return(plot)
    } else {
      if (external) {
        data.hover <- "%{x} <extra>Observed deaths</extra>"
      } else {
        data.hover <- "%{x}: %{y:.3s}<extra>Observed deaths</extra>"
      }
      plot %>%
        add_markers(
          data = data,
          x = ~date,
          y = ~True,
          color = I("red"),
          hovertemplate = data.hover
        )
    }
  }
  plots <- NULL
  if (!is.null(Eng_projection)) plots <- list("Total" = create.subplot(Eng_projection, "Total", Eng_data))
  for(subplot in plot.names) {
    if (is.null(data)) {
      plot.data <- NULL
    } else {
      plot.data <- data %>%
        filter(!!sym(by) == subplot) %>%
        group_by(date) %>%
        summarise(True = sum(value))
    }
    plots[[subplot]] <- projections %>%
      filter(by == subplot) %>%
      create.subplot(subplot, plot.data)
  }
  return(subplot(plots, nrows = num.rows))
}
```


## Epidemic summary {.tabset}

### Current $R_t$

Value of $R_t$, the average number of secondary infections due to a typical infection today.

```{r Rt-table}
get.aggregated.quantiles(Rt, "region", QUANTILES) %>%
  pivot_wider(names_from = quantile) %>%
  filter(date == ymd(date.data)) %>%
  select(Region = region, Median = `0.5`, `95% CrI (lower)` = `0.025`, `95% CrI (upper)` = `0.975`) %>%
  datatable() %>%
  formatRound(2:4)

```

### Number of infections

```{r cum-inf-sum}
format_num <- function(x) {
  return(format(signif(x, 3), big.mark = ",", scientific = FALSE, width = 0))
}

tbl_cum_inf_region <-
  get.aggregated.quantiles(cum_infections, "region", c(0.025, 0.5, 0.975)) %>%
  pivot_wider(names_from = quantile) %>%
  filter(date == ymd(date.data))
  
tbl_ar_Eng <- get.aggregated.quantiles(cum_infections, NULL, c(0.025, 0.5, 0.975))  %>%
  pivot_wider(names_from = quantile) %>%
  filter(date == ymd(date.data)) %>%
  mutate(
    population = sum(population$value),
    region = "Total"
  )

tbl_inf_region <-
  bind_rows(
    get.aggregated.quantiles(infections, NULL, c(0.025, 0.5, 0.975))  %>%
    pivot_wider(names_from = quantile) %>%
    filter(date == ymd(date.data)) %>%
    mutate(
      region = "Total"
    ),
    get.aggregated.quantiles(infections, "region", c(0.025, 0.5, 0.975)) %>%
    pivot_wider(names_from = quantile) %>%
    filter(date == ymd(date.data))
  )%>%
  mutate_at(vars(`0.025`, `0.5`, `0.975`), format_num) %>%
  transmute(
    Region = region,
    Daily_infections = paste0(`0.5`, " (", `0.025`, "--", `0.975`, ")")
  )

```

```{r cum-inf-disp}
bind_rows(
  select(tbl_ar_Eng, -population),
  tbl_cum_inf_region
) %>%
  mutate_at(vars(`0.025`, `0.5`, `0.975`), format_num) %>%
  transmute(
    Region = region,
    Cumulative_infections = paste0(`0.5`, " (", `0.025`, "--", `0.975`, ")")
  ) %>%
  left_join(tbl_inf_region, by = "Region") %>%
  datatable()
```

### Attack rate {.tabset}

The percentage of a given group that has been infected.

#### By region

```{r attack-region}
bind_rows(
  tbl_ar_Eng,
  population %>%
    group_by(region) %>%
    summarise(population = sum(value)) %>%
    left_join(tbl_cum_inf_region, by = c('region' = 'region'))
  ) %>%
  select(Region = region, Median = `0.5`, `95% CrI (lower)` = `0.025`, `95% CrI (upper)` = `0.975`, population) %>%
  mutate(
    Median = Median / population,
    `95% CrI (lower)` = `95% CrI (lower)` / population,
    `95% CrI (upper)` = `95% CrI (upper)` / population
    ) %>%
  select(-population) %>%
  datatable() %>%
  formatPercentage(2:4)
```


#### By age

```{r attack-age}
tbl_cum_inf_age <-
  get.aggregated.quantiles(cum_infections, "age", c(0.025, 0.5, 0.975)) %>%
  pivot_wider(names_from = quantile) %>%
  filter(date == ymd(date.data)) %>%
  select(age, Median = `0.5`, `95% CrI (lower)` = `0.025`, `95% CrI (upper)` = `0.975`) 

population %>%
  group_by(age) %>%
  summarise(population = sum(value)) %>%
  left_join(tbl_cum_inf_age, by = c('age' = 'age')) %>%
  mutate(
    Median = Median / population,
    `95% CrI (lower)` = `95% CrI (lower)` / population,
    `95% CrI (upper)` = `95% CrI (upper)` / population
    ) %>%
  select(-population) %>%
  arrange(match(age, age.labs)) %>%
  datatable() %>%
  formatPercentage(2:4)
```

### IFR


```{r ifr, eval=!is.null(dth.dat)}
today_cum_inf_by_age <- apply(infections[,ymd(date.data)-start.date,,,drop = FALSE], c("age", "iteration"), sum)
merge.youngest.age.groups <- function(mat, num.to.group = 2) {
  if (num.ages <= 1) {return(mat)}
  add.function <- function(x) {
    to.merge <- x[1:num.to.group]
    to.preserve <- x[(num.to.group+1):length(x)]
    return(c(sum(to.merge), to.preserve))
  }
  result <- apply(mat, "iteration", add.function)
  return(result)
}

overall_ifr <- today_cum_inf_by_age %>%
  merge.youngest.age.groups() %>%
  t() %>%
  `*`(params$prop_case_to_hosp[parameter.to.outputs,]) %>%
  rowSums() %>%
  `/`(colSums(today_cum_inf_by_age)) %>%
  quantile(QUANTILES) %>%
  enframe(name = "quantile") %>%
  mutate(age = "Overall")

params$prop_case_to_hosp %>%
  as.matrix() %>%
  `colnames<-`(dimnames(deaths)$age) %>%
  as_tibble() %>%
  pivot_longer(everything(), names_to = 'age', values_to = 'ifr') %>%
  group_by(age) %>%
  summarise(value = list(quantile(ifr, QUANTILES))) %>%
  mutate(quantile = list(names(value[[1]]))) %>%
  unnest(c(quantile, value)) %>%
  bind_rows(overall_ifr) %>%
  mutate(
    quantile = parse.percentage(quantile),
    value = paste0(signif(100 * value, 2), "%")
  ) %>%
  pivot_wider(names_from = quantile, values_from = value) %>%
  select(Age = age, Median = `0.5`, `95% CrI (lower)` = `0.025`, `95% CrI (upper)` = `0.975`) %>%
  arrange(match(Age, c("Overall", dimnames(deaths)$age))) %>%
  datatable()

# (params$prop_case_to_hosp %>%
#   as.matrix() %>%
#   `colnames<-`(dimnames(deaths)$age) %>%
#   as_tibble() %>%
#   pivot_longer(everything(), names_to = 'age', values_to = 'ifr') %>%
#   mutate(age = factor(age, levels = dimnames(deaths)$age)) %>%
#   ggplot(aes(x = age, y = ifr)) +
#   geom_violin()) %>%
#   ggplotly()
#   
# params$prop_case_to_hosp %>%
#   as.matrix() %>%
#   `colnames<-`(dimnames(deaths)$age) %>%
#   as_tibble() %>%
#   pivot_longer(everything(), names_to = 'age', values_to = 'ifr') %>%
#   group_by(age) %>%
#   summarise(value = list(quantile(ifr, c(0.025, 0.25, 0.5, 0.75, 0.975)))) %>%
#   mutate(quantile = list(names(value[[1]]))) %>%
#   unnest(c(quantile, value)) %>%
#   mutate(
#     age = factor(age, levels = dimnames(deaths)$age),
#     quantile = parse.percentage(quantile)
#   ) %>%
#   pivot_wider(names_from = quantile, values_from = value, names_prefix = "q") %>%
#   ggplot(aes(x = age, lower=q0.25, upper=q0.75, middle=q0.5, ymin=q0.025, 
#                     ymax=q0.975)) +
#   geom_boxplot(stat = "identity") +
#   scale_y_continuous()
```

### Change in infections incidence {.tabset}

#### Growth rates

```{r growth-rate-func}
signed_inf <- function(num) {
  ifelse(
    num == 0, 0,
    ifelse(num > 0, +Inf, -Inf)
  )
}

add.England <- function(data) {
  sum.all(infections)
  data <- apply(infections, c("region", "iteration", "date"), sum)
  data <- aperm(data, c("date", "region", "iteration", "age"))
  data["Total",,] <- apply(infections, c("iteration", "date"), sum)
}

today.int <- as.integer(ymd(date.data))
wanted.days <- as.character(c(today.int - 1, today.int, today.int + 1))
calc.growth.rate <- function(data) {
  data <- data %>%
    aperm(c("date", "region", "iteration", "age")) %>%
    `[`(wanted.days,,,,drop = FALSE)
  num.iterations <- dim(data)[3]
  data %>%
    apply(c("region", "iteration", "date"), sum) %>%
    as.tbl_cube(met_name = "value") %>%
    as_tibble() %>%
    bind_rows(
      apply(data, c("iteration", "date"), sum) %>%
      as.tbl_cube(met_name = "value") %>%
      as_tibble() %>%
      mutate(region = "Total")
    ) %>%
    mutate(
      date = lubridate::as_date(date)
    ) %>%
    arrange(date, iteration) %>%
    group_by(region, iteration) %>%
    mutate(gradient = lead(value) - lag(value)) %>%
    summarise(growth = 
                ifelse(value == 0,
                       signed_inf(gradient),
                       gradient / (2 * value))[2]
    ) %>%
    group_by(region) %>%
    summarise(Median = median(growth),
              `95% CrI (lower)` = quantile(growth, 0.025),
              `95% CrI (upper)` = quantile(growth, 0.975)
              ) %>%
    arrange(match(region, c("Total", regions))) %>%
    mutate(Region = str_replace_all(region, "_", " ")) %>%
    select(Region, everything()) %>%
    select(-region)
}
infections.growth.rates <- calc.growth.rate(infections)
if (!is.null(deaths)) deaths.growth.rates <- calc.growth.rate(deaths)
```

NB: negative growth rates are rates of decline. Values are daily changes.

`r knitr::kable(infections.growth.rates, digits = 2, align = 'lccc')`

#### Halving times

Halving times in days, if a region shows growth than value will be N/A.

```{r inf-halving}

infections.growth.rates %>%
  mutate_at(
    vars(-'Region'),
    ~ifelse(. > 0, NA, -1/log2(1+.))
  ) %>%
  knitr::kable(digits = 2, align = 'lccc')

```

### Change in deaths incidence {.tabset}


#### Growth rates

NB: negative growth rates are rates of decline. Values are daily changes.

```{r death-growth, eval=!is.null(deaths)}
knitr::kable(deaths.growth.rates, digits = 2, align = 'lccc')
```

#### Halving times

Halving times in days, if a region shows growth than value will be N/A.

```{r death-halving, eval=!is.null(deaths)}

deaths.growth.rates %>%
  mutate_at(
    vars(-'Region'),
    ~ifelse(. > 0, NA, -1/log2(1+.))
  ) %>%
  knitr::kable(digits = 2, align = 'lccc')

```


## Infections and deaths {.tabset}

The blue lines is show when interventions have been introduced (lockdown on 23 Mar and the relaxation of measures on 11 May), and the red line shows the date these results were produced (`r format(ymd(date.data), "%d %b")`).

### Infection incidence {.tabset}

#### By region
```{r reg-inf, cache=TRUE, cache.extra=results_hash}
make.plots(infections, by = "region")
```

#### By age
```{r age-inf, cache=TRUE, cache.extra=results_hash}
make.plots(infections, by = "age")
```

### Cumulative infections {.tabset}

#### By region
```{r reg-cum-inf-reg, cache=TRUE, cache.extra=results_hash}
make.plots(cum_infections, by = "region")
```

#### By age
```{r r-cum-inf-age, cache=TRUE, cache.extra=results_hash}
make.plots(cum_infections, by = "age")
```

```{r eval=!is.null(dth.dat), child='deaths-report.Rmd'}
```


```{r eval=!is.null(hosp.dat), child='hosp-report.Rmd'}
```

### Prob $R_t > 1$

The figure below shows the probability that $R_t$ is greater than 1 (ie: the number of infections is growing) in each region over time.
Clicking the regions in the legend allows lines to be added or removed from the figure.

```{r P-R-gt-1, cache=TRUE, cache.extra=results_hash}
(Rt > 1) %>%
  apply(c("date", "region"), sum) %>%
  `/`(length(dimnames(Rt)$iteration)) %>%
  as.tbl_cube(met_name = "value") %>%
  as_tibble() %>%
  mutate(date = as_date(date)) %>%
  filter(date <= ymd(date.data)) %>%
  create.base.subplot(1, "") %>%
  add_lines(y = ~value, x = ~date, color = ~region) %>%#, hovertemplate = "%{y:.2r}") %>%
  layout(showlegend = TRUE, yaxis = list(tickformat = "%", title = "$\\text{Probability }R_t > 1$"),
         xaxis = list(title = "Date"))
```

### $R_t$
```{r Rt-plot, cache=TRUE, cache.extra=results_hash}
make.plots(Rt, by = "region", y.format = ".2f", combine.to.England = NULL)
```

# 

Copyright Â© MRC Biostatistics Unit, University of Cambridge
