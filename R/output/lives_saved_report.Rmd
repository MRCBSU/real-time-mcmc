---
title: Direct and indirect impact of the vaccination prgramme on COVID-19 caused mortality
output:
  bookdown::html_document2: default
date: "`r Sys.Date()`"
bibliography: references.bib
---

```{r setup, echo = F}
knitr::opts_chunk$set(cache = T,
                      echo = F,
                      message = F,
                      warning = F,
                      dpi=300,
											dev = "png",
                      eval = T)
ggplot2::theme_set(ggplot2::theme_bw(10))
```

```{r get_data}
## Get the data from the shared file

## stop()
## source("smbclient.R")
## fns <- c(get_latest_file("Real time modelling output/vaccinations_deaths", "*.RData", cache_path))
fns <- "deaths_comparison_prev.RData"
```


Results are based on the PHE/Cambridge epidemiological model, which has been used throughout the pandemic to nowcast and forecast the number of infections and deaths [@birr_realtime_2020b; @_nowcasting_]. The model is constantly being improved to accurately capture the pandemic as it develops. Vaccination rates in the model are based on the actual number of doses administered and the vaccine is assumed to reduce susceptibility to COVID-19 as well as mortality once infected. To infer the impact of vaccination the model was fitted to both ONS prevalence and daily COVID-19 mortality data in England, resulting in posterior samples for a range of epidemiological parameters. The posterior samples were then used to simulate the number of infections and deaths that would have occured without vaccination. Finally, the total impact was calculated by comparing the infection and mortality estimates with vaccination versus the simulated outcomes without vaccination (Figure \@ref(fig:figMortality); Table \@ref(tab:tableMortality)).

The no-vaccination scenario assumes that no other interventions are implemented to reduce incidence and mortality, which is likely to result in unrealistically high incidence and mortality in the future. This is unavoidable though, because it is impossible to predict what type of interventions would have been implemented in the absence of vaccination. The no-vaccination scenario should, therefore, be interpreted as a worst case scenario.". 

```{r tabAssumptions, eval = F}
tibble(
  Against = c(rep("Infection", 2), rep("Disease", 4)),
  Type = c("", "", "AZ", "AZ", "Pfizer", "Pfizer"),        
  Dose = rep(c("1", "2"), 3),
  Efficacy = c(48, 60, 74, 88, 90, 98)) %>%
  dplyr::mutate(Efficacy = paste0(Efficacy, "%")) %>%
  knitr::kable(caption = "Main vaccine efficacy assumptions in the model")
```

```{r}
# Load the data into a data frame
# fns holds the filename
fns %>% purrr::map(function(fn) {
  load(fn)
  dnv <- apply(deaths.no.vac, c(1,3), sum)
  dv <- apply(deaths.vac, c(1,3), sum)
  inv <- apply(infecs.no.vac, c(1,3), sum)
  iv <- apply(infecs.vac, c(1,3), sum)
  pnv <- apply(preval.no.vac, c(1,3), sum)
  pv <- apply(preval.vac, c(1,3), sum)
  as.data.frame(dnv) %>%
    dplyr::mutate(Outcome = "Mortality", Scenario = "No vaccination", np = dplyr::row_number()) %>% 
    dplyr::bind_rows(
      as.data.frame(dv) %>%
        dplyr::mutate(Outcome = "Mortality", Scenario = "Vaccination", np = dplyr::row_number())) %>%
    dplyr::bind_rows(
      as.data.frame(inv) %>%
        dplyr::mutate(Outcome = "Infection", Scenario = "No vaccination", np = dplyr::row_number())) %>% 
    dplyr::bind_rows(
      as.data.frame(iv) %>%
        dplyr::mutate(Outcome = "Infection", Scenario = "Vaccination", np = dplyr::row_number())) %>%
    dplyr::bind_rows(
      as.data.frame(pnv) %>%
        dplyr::mutate(Outcome = "Prevalence", Scenario = "No vaccination", np = dplyr::row_number())) %>% 
    dplyr::bind_rows(
      as.data.frame(pv) %>%
        dplyr::mutate(Outcome = "Prevalence", Scenario = "Vaccination", np = dplyr::row_number())) %>%
      dplyr::mutate(Model = dplyr::case_when(stringr::str_detect(fn, "prev") ~ "ONS/Death", T ~ "Death"))
}) %>% dplyr::bind_rows() -> df

stringr::str_extract(fns[1], "\\d{8}") -> fn_date
fn_date %>% lubridate::as_date(format = "%Y%m%d") -> cutDate

qsave(fn_date, "date.qs")
qsave(fn_date, file.path(cache_path, "last_date.qs"))

df %>% tidyr::gather(Date, value, -Scenario, -Model, -np, -Outcome) %>%
  dplyr::mutate(Date = lubridate::as_date(as.numeric(Date))) %>%
# Till the end of last week
  dplyr::filter(Date <= cutDate) -> data_df

# Throw if we have more than one model
if (length(unique(data_df$Model)) != 1)
  stop("If we compare multiple models then we should adapt the figures below")

qsave(data_df, "outcomes.qs")
```



```{r figMortality, fig.cap="Inferred and predicted incidence, mortality and prevalence with and without vaccination in England.", fig.height = 3.5}
data_df <- qread("outcomes.qs")

# We only use the data up till now
cutDate <- max(data_df$Date)


data_df %>%
  dplyr::filter(Date > lubridate::as_date("2021-01-01")) %>%
  dplyr::group_by(Date, Scenario, Model, Outcome) %>%
  dplyr::summarise(Quantile = c(0.025, 0.25, 0.5, 0.75, 0.975),
                   value = quantile(value, Quantile)) %>%
  dplyr::ungroup() %>%
  tidyr::spread(Quantile, value) -> plot_df
    
ggplot(data = plot_df) +
  geom_ribbon(aes(x = Date, ymin = `0.025`, ymax = `0.975`, fill = Scenario), alpha = 0.3) +
  geom_ribbon(aes(x = Date, ymin = `0.25`, ymax = `0.75`, fill = Scenario), alpha = 0.3) +
  facet_wrap(. ~ Outcome, nrow = 1, scales = "free") +
  theme(legend.position="bottom") +
  ylab("Daily incidence")
```

```{r cumulative, fig.cap = "Averted number of infections (left) and deaths (right) due to vaccination (cumulativily).", fig.height = 3.5}
data_df %>%
  dplyr::filter(Outcome != "Prevalence") %>%
  tidyr::spread(Scenario, value) %>%
  dplyr::mutate(Reduction = `No vaccination` - `Vaccination`) %>%
  dplyr::group_by(Model, Outcome, np) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(value = cumsum(Reduction)) %>%
  dplyr::group_by(Model, Outcome, Date) %>%
  dplyr::summarise(Quantile = c(0.025, 0.25, 0.5, 0.75, 0.975),
                   value = round(quantile(value, Quantile))) %>%
  dplyr::ungroup() %>%
  dplyr::filter(Date > lubridate::as_date("2021-01-01")) %>%
  tidyr::spread(Quantile, value) -> plot_df

ggplot(data = plot_df) +
  geom_ribbon(aes(x = Date, ymin = `0.025`, ymax = `0.975`), fill = "Red", alpha = 0.3) +
  geom_ribbon(aes(x = Date, ymin = `0.25`, ymax = `0.75`), fill = "Red", alpha = 0.3) +
  facet_wrap(. ~ Outcome, nrow = 1, scales = "free") +
  theme(legend.position="bottom") +
  ylab("Averted infections/mortality (cumulative)")
```

```{r tableMortality}
data_df %>%
  dplyr::filter(Outcome != "Prevalence") %>%
  tidyr::spread(Scenario, value) %>%
  dplyr::mutate(Reduction = `No vaccination` - `Vaccination`) %>%
  dplyr::group_by(np, Model, Outcome) %>%
  dplyr::summarise(Reduction = sum(Reduction)) %>%
  dplyr::group_by(Model, Outcome) %>%
  dplyr::summarise(Quantile = c(0.025, 0.25, 0.5, 0.75, 0.975),
                   Reduction = round(quantile(Reduction, Quantile))) %>%
  dplyr::summarise(Reduction = paste(Reduction[3], " [", Reduction[1], ", ", Reduction[5], "]")) %>%
  dplyr::mutate(Model = "PHE/Cambridge") %>%
  knitr::kable(caption = paste0("Inferred reduction in infections and mortality as the result of vaccination up to ", cutDate))
```

```{r attack_rate_by_age, eval = F}
dimnames(infecs.vac) -> lst
ag <- factor(lst$age, levels = lst$age)

tibble::tibble() %>% tidyr::expand(Date = lubridate::as_date(as.numeric(lst$date)), AgeGroup = ag, np = as.numeric(lst$iteration)) %>%
  dplyr::mutate(value = as.vector(infecs.vac)) %>%
  dplyr::arrange(np, AgeGroup, Date) -> df

df %>%
  dplyr::group_by(np, AgeGroup) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(value = cumsum(value)) %>%
  dplyr::mutate(Week = lubridate::isoweek(Date), Year = lubridate::isoyear(Date)) %>%
  dplyr::group_by(np, Week, Year, AgeGroup) %>%
  # Take the last day of the week
  dplyr::arrange(Date) %>%
  dplyr::slice(dplyr::n()) %>%
  dplyr::ungroup() -> cumulative_incidence_df
  #dplyr::group_by(Week, Year, AgeGroup) %>%
  #dplyr::summarise(Quantile = c(0.025, 0.25, 0.5, 0.75, 0.975),
  #               value = quantile(value, Quantile)) %>%
  #dplyr::ungroup() %>%
  #dplyr::arrange(Year, Week, Quantile) ->
  #  cumulative_incidence_df

qs::qsave(cumulative_incidence_df, file = "cumulative_incidence.qs")
```

## Log transformed

```{r figMortalityLog, fig.cap="Inferred and predicted incidence, mortality and prevalence with and without vaccination in England.", fig.height = 3.5}
data_df <- qread("outcomes.qs")
cutDate <- max(data_df$Date)

data_df %>%
  dplyr::filter(Date > lubridate::as_date("2021-01-01")) %>%
  dplyr::group_by(Date, Scenario, Model, Outcome) %>%
  dplyr::summarise(Quantile = c(0.025, 0.25, 0.5, 0.75, 0.975),
                   value = quantile(value, Quantile)) %>%
  dplyr::ungroup() %>%
  tidyr::spread(Quantile, value) -> plot_df
    
ggplot(data = plot_df) +
  geom_ribbon(aes(x = Date, ymin = `0.025`, ymax = `0.975`, fill = Scenario), alpha = 0.3) +
  geom_ribbon(aes(x = Date, ymin = `0.25`, ymax = `0.75`, fill = Scenario), alpha = 0.3) +
  facet_wrap(. ~ Outcome, nrow = 1, scales = "free") +
  theme(legend.position="bottom") +
  ylab("Daily incidence") +
  scale_y_log10()

```

```{r cumulativeLog, fig.cap = "Averted number of infections (left) and deaths (right) due to vaccination (cumulativily).", fig.height = 3.5}
data_df %>%
  dplyr::filter(Outcome != "Prevalence") %>%
  tidyr::spread(Scenario, value) %>%
  dplyr::mutate(Reduction = `No vaccination` - `Vaccination`) %>%
  dplyr::group_by(Model, Outcome, np) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(value = cumsum(Reduction)) %>%
  dplyr::group_by(Model, Outcome, Date) %>%
  dplyr::summarise(Quantile = c(0.025, 0.25, 0.5, 0.75, 0.975),
                   value = round(quantile(value, Quantile))) %>%
  dplyr::ungroup() %>%
  dplyr::filter(Date > lubridate::as_date("2021-01-01")) %>%
  tidyr::spread(Quantile, value) -> plot_df

ggplot(data = plot_df) +
  geom_ribbon(aes(x = Date, ymin = `0.025`, ymax = `0.975`), fill = "Red", alpha = 0.3) +
  geom_ribbon(aes(x = Date, ymin = `0.25`, ymax = `0.75`), fill = "Red", alpha = 0.3) +
  facet_wrap(. ~ Outcome, nrow = 1, scales = "free") +
  theme(legend.position="bottom") +
  ylab("Averted infections/mortality (cumulative)") +
  scale_y_log10()

```

# References
